%h2 All Users

%p
  Each
  %strong user
  has a unique email address.  Each user can have multiple
  = link_to "attendees.", :attendees
%p
  %strong Admins
  can do anything.
  %strong Staff
  can see anything.
  Do not promote too many of either.

%p
  There are
  %strong
    = @users.count < 10 ? @users.count.humanize : @users.count
  user#{@users.count != 1 ? "s" : ""} registered, with
  %strong
    - attendees = @users.reduce(0) { |sum, user| sum + user.attendees.count}
    = attendees < 10 ? attendees.humanize : attendees
  attendee#{attendees != 1 ? "s" : ""}.
  %strong
    - incomplete = @users.reduce(0) { |sum, user| user.attendees.count > 0 ? sum : sum + 1 }
    = incomplete < 10 ? incomplete.humanize.capitalize() : incomplete
  user account#{incomplete != 1 ? "s do" : " does"} not yet have any registered attendees.

- if can? :create, User
  .row-of-buttons
    = button_to 'New User', new_user_path, :method => 'get'

%table.semantic.fullwidth.zebra
  %thead
    %tr
      %th= link_to "Role", :sort => :role
      %th= link_to "Email", :sort => :email, :drn => params[:drn] == "asc" ? :desc : :asc
      %th Attendees
      %th 
        - drn = (params[:sort] == 'num_attendees' && params[:drn] == "asc") ? :desc : :asc
        = link_to "# Attendees", :sort => 'num_attendees', :drn => drn
      - [:created_at, :current_sign_in_at].each do |a|
        %th
          - drn = (params[:sort] == a.to_s && params[:drn] == "asc") ? :desc : :asc
          = link_to trl_attr("user", a), :sort => a, :drn => drn
      %th{:colspan => "2"}
  %tbody
    - @users.each do |user|
      %tr
        %td{ :class => role_emphasis_class(user) }= user.role_name
        %td
          .hardwrap{:style => "max-width:200px;"}= link_to user.email, print_cost_summary_for_user_path(user)
        %td
          - attendees = user.attendees.sort { |a,b| a.created_at <=> b.created_at }
          - attendees.each_with_index do |atn, ix|
            - a = atn.full_name
            - a += ' (' + atn.alternate_name + ')' if atn.alternate_name.present?
            - a += ' (Canceled)' if atn.cancelled?
            = link_to a, print_summary_for_attendee_path(atn)
            = "*" if ix == 0 && attendees.length > 1
            %br
        %td
          -# `count` would exec. a query, `length` doesn't because of `includes`
          = user.attendees.length
        %td= user.created_at.to_date.to_formatted_s(:rfc822)
        %td
          - if user.current_sign_in_at.present?
            = user.current_sign_in_at.to_date.to_formatted_s(:rfc822)
        %td= link_to 'Account', user

%p
  * First attendee to be created
